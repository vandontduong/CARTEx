#!/usr/bin/env Rscript

### Script name: GSE136184-2-annotate.R
### Description: annotate seurat object for GSE136184
### Author: Vandon Duong

# track time
ptm <- proc.time()
print("The script is starting...")

####################################################################################################
####################################### Initialize environment #####################################
####################################################################################################

set.seed(123)
source("/oak/stanford/groups/cmackall/vandon/CARTEx/cartex-utilities.R")
experiment = 'GSE136184'
setwd(paste(PATH_EXPERIMENTS, experiment, sep = ''))

####################################################################################################
######################################## Cell cycle analysis #######################################
####################################################################################################

expt.obj <- readRDS(paste('./data/', experiment, '_cs.rds', sep = ''))

# https://satijalab.org/seurat/articles/cell_cycle_vignette.html

# Read in the expression matrix The first row is a header row, the first column is rownames
exp.mat <- read.table(file = paste(PATH_CELLANNOTATE, "nestorawa_forcellcycle_expressionMatrix.txt", sep = ''), header = TRUE, as.is = TRUE, row.names = 1)

# A list of cell cycle markers, from Tirosh et al, 2015, is loaded with Seurat.  We can
# segregate this list into markers of G2/M phase and markers of S phase
s.genes <- cc.genes$s.genes
g2m.genes <- cc.genes$g2m.genes

expt.obj <- CellCycleScoring(expt.obj, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)

# view cell cycle scores and phase assignments
head(expt.obj[[]])

# Visualize the distribution of cell cycle markers across
ridgeplt <- RidgePlot(expt.obj, features = c("PCNA", "TOP2A", "MCM6", "MKI67"), ncol = 2)
generate_figs(ridgeplt, paste('./plots/', experiment, '_cs_prepare_ridgeplt', sep = ''))

expt.obj <- RunPCA(expt.obj, features = c(s.genes, g2m.genes))
# DimPlot(expt.obj)

# regress cell cycle
expt.obj <- ScaleData(expt.obj, vars.to.regress = c("S.Score", "G2M.Score"), features = rownames(expt.obj))
# Now, a PCA on the variable genes no longer returns components associated with cell cycle
expt.obj <- RunPCA(expt.obj, features = VariableFeatures(expt.obj), nfeatures.print = 10)

expt.obj@meta.data$Phase <- factor(expt.obj@meta.data$Phase, levels = c('G1', 'S', 'G2M'))

# ANALYZE CELL CYCLE DATA FROM SEURAT OBJECT
md <- expt.obj@meta.data %>% as.data.table
md[, .N, by = c("orig.ident", "Phase")]
phase_data <- md[, .N, by = c("Phase")]
setorder(phase_data, cols = "Phase")
phase_data$percent <- round(100*phase_data$N / sum(phase_data$N), digits = 1)
phase_data$label <- paste(phase_data$Phase, " (", phase_data$percent,"%)", sep = "")
phase_data$cols <- hcl.colors(n = nrow(phase_data), palette = "Temps")
barplot_phase <- ggplot(data= phase_data, aes(x=Phase, y=percent)) + geom_bar(stat="identity", fill = phase_data$cols)
generate_figs(barplot_phase, paste('./plots/', experiment, '_cs_prepare_barplot_phase', sep = ''))

umap_phase <- DimPlot(expt.obj, reduction = 'umap', group.by = "Phase", cols = phase_data$cols, shuffle = TRUE, seed = 123, pt.size = 0.1) + theme(plot.title = element_blank())
generate_figs(umap_phase, paste('./plots/', experiment, '_cs_prepare_umap_phase', sep = ''), c(3, 2))

umap_phase_highlight <- DimPlotHighlightIdents(expt.obj, Phase, 'umap', 'blue', 0.1, 3)
generate_figs(umap_phase_highlight, paste('./plots/', experiment, '_cs_prepare_umap_phase_highlight', sep = ''), c(15, 6))


saveRDS(expt.obj, file = paste('./data/', experiment, '_cs_cellcycle.rds', sep = ''))

# expt.obj <- readRDS(paste('./data/', experiment, '_cs_cellcycle.rds', sep = ''))


####################################################################################################
######################################## Cell type annotation ######################################
####################################################################################################

# https://bioconductor.org/books/release/SingleRBook/introduction.html
# https://github.com/dviraran/SingleR/issues/150
# https://support.bioconductor.org/p/9136971/
# https://rdrr.io/github/LTLA/celldex/man/MonacoImmuneData.html
# https://rdrr.io/github/LTLA/celldex/man/DatabaseImmuneCellExpressionData.html

test_assay <- LayerData(expt.obj) # LayerData() is the updated function; GetAssayData() was depreciated

# azimuth.obj <- readRDS("/oak/stanford/groups/cmackall/vandon/CARTEx/experiments/GSE164378/data/GSE164378_cellcycle.rds")
azimuth.obj <- readRDS(paste(PATH_CELLANNOTATE, "AzimuthPBMC.rds", sep = ''))
azimuth.obj.md <- azimuth.obj@meta.data %>% as.data.table
azimuth.obj.md[, .N, by = c("celltype.l1", "celltype.l2")]
azimuth.obj <- SetIdent(azimuth.obj, value = "celltype.l1")
azimuth.obj <- subset(azimuth.obj, idents = c("CD8 T"))
# downsample
azimuth.obj <- SetIdent(azimuth.obj, value = "celltype.l2")
azimuth.obj <- subset(azimuth.obj, downsample = 100)
azimuth_assay <- LayerData(azimuth.obj)

# https://bioconductor.org/help/course-materials/2019/BSS2019/04_Practical_CoreApproachesInBioconductor.html#subsetting-summarizedexperiment
# monaco.obj <- MonacoImmuneData(ensembl=F)
monaco.obj <- readRDS(paste(PATH_CELLANNOTATE, "MonacoImmuneData.rds", sep = ''))
monaco.obj.md <- monaco.obj@colData %>% as.data.table
monaco.obj.md[, .N, by = c("label.main", "label.fine")]
monaco.index <- monaco.obj$label.main %in% c('CD8+ T cells')
monaco.obj <- monaco.obj[, monaco.index]
unique(monaco.obj$label.main)

# dice.obj <- DatabaseImmuneCellExpressionData(ensembl=F)
dice.obj <- readRDS(paste(PATH_CELLANNOTATE, "DatabaseImmuneCellExpressionData.rds", sep = ''))
dice.obj.md <- dice.obj@colData %>% as.data.table
dice.obj.md[, .N, by = c("label.main", "label.fine")]
dice.index <- dice.obj$label.main %in% c('T cells, CD8+')
dice.obj <- dice.obj[, dice.index]
# downsample
dice.obj@assays@data@listData$logcounts <- downsampleMatrix(dice.obj@assays@data@listData$logcounts, prop = 0.05)
unique(dice.obj$label.main)

# SingleR() has this error, likely due to Seurat versioning
# Error: useNames = NA is defunct. Instead, specify either useNames = TRUE or useNames = FALSE.
# solution is to downgrade matrixStats, according to https://github.com/satijalab/seurat/issues/7501#issuecomment-1854571904
# remotes::install_version("matrixStats", version="1.1.0")

azimuth.predictions <- SingleR(test = test_assay, assay.type.test = 1, ref = azimuth_assay, labels = azimuth.obj$celltype.l2)
table(azimuth.predictions$labels)
saveRDS(azimuth.predictions, paste(file='./data/', experiment, '_cs_prepare_azimuth_predictions.rds', sep = ''))
write.csv(azimuth.predictions, paste(file='./data/', experiment, '_cs_prepare_azimuth_predictions.csv', sep = ''))
# azimuth.predictions <- readRDS(paste('./data/', experiment, '_azimuth_predictions.rds', sep = ''))

expt.obj[["azimuth"]] <- azimuth.predictions$labels
unique(expt.obj[["azimuth"]])
expt.obj@meta.data$azimuth <- factor(expt.obj@meta.data$azimuth, levels = c('CD8 Naive', 'CD8 Proliferating'))

# umap_predicted_azimuth <- DimPlot(expt.obj, reduction = "umap", group.by = "azimuth", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()
umap_predicted_azimuth <- DimPlot(expt.obj, reduction = "umap", group.by = "azimuth", shuffle = TRUE, seed = 123)
generate_figs(umap_predicted_azimuth, paste('./plots/', experiment, '_cs_prepare_umap_predicted_azimuth', sep = ''))

umap_predicted_azimuth_highlight <- DimPlotHighlightIdents(expt.obj, azimuth, 'umap', 'blue', 0.1, 2)
generate_figs(umap_predicted_azimuth_highlight, paste('./plots/', experiment, '_cs_prepare_umap_predicted_azimuth_highlight', sep = ''), c(12, 8))


monaco.predictions <- SingleR(test = test_assay, assay.type.test = 1, ref = monaco.obj, labels = monaco.obj$label.fine)
table(monaco.predictions$labels)
saveRDS(monaco.predictions, file=paste('./data/', experiment, '_cs_prepare_monaco_predictions.rds', sep = ''))
write.csv(monaco.predictions, file=paste('./data/', experiment, '_cs_prepare_monaco_predictions.csv', sep = ''))
# monaco.predictions <- readRDS(paste('./data/', experiment, '_monaco_predictions.rds', sep = ''))

expt.obj[["monaco"]] <- monaco.predictions$labels
unique(expt.obj[["monaco"]])
expt.obj@meta.data$monaco <- factor(expt.obj@meta.data$monaco, levels = c('Naive CD8 T cells', 'Central memory CD8 T cells', 'Effector memory CD8 T cells', 'Terminal effector CD8 T cells'))

# umap_predicted_monaco <- DimPlot(expt.obj, reduction = "umap", group.by = "monaco", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()
umap_predicted_monaco <- DimPlot(expt.obj, reduction = "umap", group.by = "monaco", shuffle = TRUE, seed = 123, cols = c('deepskyblue', 'seagreen', 'darkgoldenrod', 'plum3'), pt.size = 0.1) + 
  theme(plot.title = element_blank()) + scale_color_manual(labels=c("N", "CM", "EM", "TE"), values = c('deepskyblue', 'seagreen', 'darkgoldenrod', 'plum3'))
generate_figs(umap_predicted_monaco, paste('./plots/', experiment, '_cs_prepare_umap_predicted_monaco', sep = ''), c(2.9, 2))

umap_predicted_monaco_highlight <- DimPlotHighlightIdents(expt.obj, monaco, 'umap', 'blue', 0.1, 2)
generate_figs(umap_predicted_monaco_highlight, paste('./plots/', experiment, '_cs_prepare_umap_predicted_monaco_highlight', sep = ''), c(22, 20))


dice.predictions <- SingleR(test = test_assay, assay.type.test = 1, ref = dice.obj, labels = dice.obj$label.fine)
table(dice.predictions$labels)
saveRDS(dice.predictions, file=paste('./data/', experiment, '_cs_prepare_dice_predictions.rds', sep = ''))
write.csv(dice.predictions, file=paste('./data/', experiment, '_cs_prepare_dice_predictions.csv', sep = ''))
# dice.predictions <- readRDS(paste('./data/', experiment, '_dice_predictions.rds', sep = ''))

expt.obj[["dice"]] <- dice.predictions$labels
unique(expt.obj[["dice"]])
expt.obj@meta.data$dice <- factor(expt.obj@meta.data$dice, levels = c('T cells, CD8+, naive', 'T cells, CD8+, naive, stimulated'))

# umap_predicted_dice <- DimPlot(expt.obj, reduction = "umap", group.by = "dice", label = TRUE, label.size = 3, repel = TRUE) + NoLegend()
umap_predicted_dice <- DimPlot(expt.obj, reduction = "umap", group.by = "dice", shuffle = TRUE, seed = 123)
generate_figs(umap_predicted_dice, paste('./plots/', experiment, '_cs_prepare_umap_predicted_dice', sep = ''))

umap_predicted_dice_highlight <- DimPlotHighlightIdents(expt.obj, dice, 'umap', 'blue', 0.1, 2)
generate_figs(umap_predicted_dice_highlight, paste('./plots/', experiment, '_cs_prepare_umap_predicted_dice_highlight', sep = ''), c(12, 8))


featureplot_Tcell_markers <- FeaturePlot(expt.obj, features = c("CD8A", "CD8B", "PDCD1"))
generate_figs(featureplot_Tcell_markers, paste('./plots/', experiment, '_cs_prepare_featureplot_Tcell_markers', sep = ''))


# BAR CHARTS of CELL TYPES
md <- expt.obj@meta.data %>% as.data.table
md[, .N, by = c("azimuth", "monaco", "dice")]


barplot_azimuth_seurat_clusters <- BarPlotStackSplit(expt.obj, 'azimuth', 'seurat_clusters')
generate_figs(barplot_azimuth_seurat_clusters, paste('./plots/', experiment, '_cs_prepare_barplot_azimuth_seurat_clusters', sep = ''), c(8,4))

barplot_monaco_seurat_clusters <- BarPlotStackSplit(expt.obj, 'monaco', 'seurat_clusters')
generate_figs(barplot_monaco_seurat_clusters, paste('./plots/', experiment, '_cs_prepare_barplot_monaco_seurat_clusters', sep = ''), c(8,4))

barplot_dice_seurat_clusters <- BarPlotStackSplit(expt.obj, 'dice', 'seurat_clusters')
generate_figs(barplot_dice_seurat_clusters, paste('./plots/', experiment, '_cs_prepare_barplot_dice_seurat_clusters', sep = ''), c(8,4))

barplot_phase_seurat_clusters <- BarPlotStackSplit(expt.obj, 'Phase', 'seurat_clusters')
generate_figs(barplot_phase_seurat_clusters, paste('./plots/', experiment, '_cs_prepare_barplot_phase_seurat_clusters', sep = ''), c(8,4))

barplot_azimuth_age_group <- BarPlotStackSplit(expt.obj, 'azimuth', 'AgeGroup2')
generate_figs(barplot_azimuth_age_group, paste('./plots/', experiment, '_cs_prepare_barplot_azimuth_age_group', sep = ''), c(8,4))

barplot_monaco_age_group <- BarPlotStackSplit(expt.obj, 'monaco', 'AgeGroup2', color_set = c('deepskyblue','seagreen','darkgoldenrod','plum3')) + scale_x_discrete(labels = c("N", "U30", "U50", "U70", "E"))
generate_figs(barplot_monaco_age_group, paste('./plots/', experiment, '_cs_prepare_barplot_monaco_age_group', sep = ''), c(4,2))

barplot_dice_age_group <- BarPlotStackSplit(expt.obj, 'dice', 'AgeGroup2')
generate_figs(barplot_dice_age_group, paste('./plots/', experiment, '_cs_prepare_barplot_dice_age_group', sep = ''), c(8,4))

barplot_phase_age_group <- BarPlotStackSplit(expt.obj, 'Phase', 'AgeGroup2', color_set = hcl.colors(3, palette = "Temps")) + scale_x_discrete(labels = c("N", "U30", "U50", "U70", "E"))
generate_figs(barplot_phase_age_group, paste('./plots/', experiment, '_cs_prepare_barplot_phase_age_group', sep = ''), c(2.8,2))


barplot_monaco_age_group_slim <- barplot_monaco_age_group + theme(legend.position = "none")
generate_figs(barplot_monaco_age_group_slim, paste('./plots/', experiment, '_cs_prepare_barplot_monaco_age_group_slim', sep = ''), c(1.75,1.75))

barplot_phase_age_group_slim <- barplot_phase_age_group + theme(legend.position = "none")
generate_figs(barplot_phase_age_group_slim, paste('./plots/', experiment, '_cs_prepare_barplot_phase_age_group_slim', sep = ''), c(1.75,1.75))


###
###
###



# Exhaustion as linear differentiation from progenitors to terminal
expt.obj <- annotate_Tex_linear_diff(expt.obj)

table(expt.obj$Tex_linear_diff)

umap_predicted_tex_linear_diff <- DimPlot(expt.obj, reduction = "umap", group.by = "Tex_linear_diff", shuffle = TRUE, seed = 123, cols =  c('royalblue', 'maroon', 'lightgrey'), pt.size = 0.1) + 
  theme(plot.title = element_blank()) + scale_color_manual(labels=c("P", "T", "U"), values = c('royalblue', 'maroon', 'lightgrey'))
generate_figs(umap_predicted_tex_linear_diff, paste('./plots/', experiment, '_prepare_umap_predicted_tex_linear_diff', sep = ''), c(2.9, 2))

umap_features_TCF7_HAVCR2 <- FeaturePlot(expt.obj, features = c("TCF7", "HAVCR2"), pt.size = 0.1)
generate_figs(umap_features_TCF7_HAVCR2, paste('./plots/', experiment, '_prepare_umap_features_TCF7_HAVCR2', sep = ''), c(5, 2))

umap_features_TCF7_HAVCR2_gradient <- FeaturePlot(expt.obj, features = c("TCF7", "HAVCR2"), pt.size = 0.1, blend = TRUE, cols = c('lightgrey', 'royalblue', 'maroon'))
generate_figs(umap_features_TCF7_HAVCR2_gradient, paste('./plots/', experiment, '_prepare_umap_features_TCF7_HAVCR2_gradient', sep = ''), c(7, 2))


barplot_tex_linear_diff_age_group_2 <- BarPlotStackSplit(expt.obj, 'Tex_linear_diff', 'AgeGroup2', color_set =  c('royalblue', 'maroon', 'lightgrey')) + scale_x_discrete(labels = c("N", "U30", "U50", "U70", "E"))
barplot_tex_linear_diff_age_group_2_slim <- barplot_tex_linear_diff_age_group_2 + theme(legend.position = "none")
generate_figs(barplot_tex_linear_diff_age_group_2_slim, paste('./plots/', experiment, '_prepare_barplot_tex_linear_diff_age_group_2_slim', sep = ''), c(1.75,1.75))


barplot_monaco_tex_linear_diff <- BarPlotStackSplit(expt.obj, 'monaco', 'Tex_linear_diff', color_set =  c('deepskyblue', 'seagreen', 'darkgoldenrod', 'plum3')) + scale_x_discrete(labels = c('P', 'T', 'U'))
barplot_monaco_tex_linear_diff_slim <- barplot_monaco_tex_linear_diff + theme(legend.position = "none")
generate_figs(barplot_monaco_tex_linear_diff_slim, paste('./plots/', experiment, '_prepare_barplot_monaco_tex_linear_diff_slim', sep = ''), c(1.25,1.75))

###
###

saveRDS(expt.obj, file = paste('./data/', experiment, '_cs_annotated.rds', sep = ''))

# expt.obj <- readRDS(paste('./data/', experiment, '_cs_annotated.rds', sep = ''))

####################################################################################################
########################################### Entropy scoring ########################################
####################################################################################################

# The ROGUE method was developed to robustly measure the purity of cell populations

# expt.obj <- UpdateSeuratObject(expt.obj)

# rogue.res <- EntropyScore(expt.obj, 'seurat_clusters', 'Group')
# rogue.res <- rogue.res[ , SortNumStrList(colnames(rogue.res), shift = FALSE)]
# rogue_boxplot_seurat_clusters_group <- rogue.boxplot(rogue.res)
# generate_figs(rogue_boxplot_seurat_clusters_group, paste('./plots/', experiment, '_cs_prepare_rogue_boxplot_seurat_clusters_group', sep = ''), c(8,4))

# rogue.res <- EntropyScore(expt.obj, 'monaco', 'Group')
# rogue_boxplot_monaco_group <- rogue.boxplot(rogue.res)
# generate_figs(rogue_boxplot_monaco_group, paste('./plots/', experiment, '_cs_prepare_rogue_boxplot_monaco_group', sep = ''), c(8,4))


####################################################################################################
######################################### Signature scoring ########################################
####################################################################################################

expt.obj <- ScoreSubroutine(expt.obj)



# UMAP of cell state scores
umap_sig_activationi <- DimPlot(expt.obj, group.by = "Activationi", shuffle = TRUE, seed = 123)
generate_figs(umap_sig_activationi, paste('./plots/', experiment, '_cs_prepare_umap_sig_activationi', sep = ''))

umap_sig_activationi_highlight <- DimPlotHighlightIdents(expt.obj, Activationi, 'umap', 'blue', 0.1, 4)
generate_figs(umap_sig_activationi_highlight, paste('./plots/', experiment, '_cs_prepare_umap_sig_activationi_highlight', sep = ''), c(10, 8))

umap_sig_anergyi <- DimPlot(expt.obj, group.by = "Anergyi", shuffle = TRUE, seed = 123)
generate_figs(umap_sig_anergyi, paste('./plots/', experiment, '_cs_prepare_umap_sig_anergyi', sep = ''))

umap_sig_anergyi_highlight <- DimPlotHighlightIdents(expt.obj, Anergyi, 'umap', 'blue', 0.1, 4)
generate_figs(umap_sig_anergyi_highlight, paste('./plots/', experiment, '_cs_prepare_umap_sig_anergyi_highlight', sep = ''), c(10, 8))

umap_sig_stemnessi <- DimPlot(expt.obj, group.by = "Stemnessi", shuffle = TRUE, seed = 123)
generate_figs(umap_sig_stemnessi, paste('./plots/', experiment, '_cs_prepare_umap_sig_stemnessi', sep = ''))

umap_sig_stemnessi_highlight <- DimPlotHighlightIdents(expt.obj, Stemnessi, 'umap', 'blue', 0.1, 4)
generate_figs(umap_sig_stemnessi_highlight, paste('./plots/', experiment, '_cs_prepare_umap_sig_stemnessi_highlight', sep = ''), c(10, 8))

umap_sig_senescencei <- DimPlot(expt.obj, group.by = "Senescencei", shuffle = TRUE, seed = 123)
generate_figs(umap_sig_senescencei, paste('./plots/', experiment, '_cs_prepare_umap_sig_senescencei', sep = ''))

umap_sig_senescencei_highlight <- DimPlotHighlightIdents(expt.obj, Stemnessi, 'umap', 'blue', 0.1, 4)
generate_figs(umap_sig_senescencei_highlight, paste('./plots/', experiment, '_cs_prepare_umap_sig_senescencei_highlight', sep = ''), c(10, 8))


# better way to generate UMAPs for scored cells

fix.sc <- scale_color_gradientn(colours = c("blue","lightgrey","red"), limits = c(-4,4))
umap_CARTEx_84 <- FeaturePlot(expt.obj, features = c("CARTEx_84"), order = FALSE, pt.size = 0.1) + fix.sc + theme(plot.title = element_blank())
umap_CARTEx_200 <- FeaturePlot(expt.obj, features = c("CARTEx_200"), order = FALSE, pt.size = 0.1) + fix.sc + theme(plot.title = element_blank())
umap_CARTEx_630 <- FeaturePlot(expt.obj, features = c("CARTEx_630"), order = FALSE, pt.size = 0.1) + fix.sc + theme(plot.title = element_blank())
umap_sig_activation <- FeaturePlot(expt.obj, features = c("Activation"), order = FALSE, pt.size = 0.1) + fix.sc + theme(plot.title = element_blank())
umap_sig_anergy <- FeaturePlot(expt.obj, features = c("Anergy"), order = FALSE, pt.size = 0.1) + fix.sc + theme(plot.title = element_blank())
umap_sig_stemness <- FeaturePlot(expt.obj, features = c("Stemness"), order = FALSE, pt.size = 0.1) + fix.sc + theme(plot.title = element_blank())
umap_sig_senescence <- FeaturePlot(expt.obj, features = c("Senescence"), order = FALSE, pt.size = 0.1) + fix.sc + theme(plot.title = element_blank())
umap_NKlike_Tex <- FeaturePlot(expt.obj, features = c("NKlike_Tex"), order = FALSE, pt.size = 0.1) + fix.sc + theme(plot.title = element_blank())
umap_LCMV_Tex <- FeaturePlot(expt.obj, features = c("LCMV_Tex"), order = FALSE, pt.size = 0.1) + fix.sc + theme(plot.title = element_blank())
umap_BBD_Tex <- FeaturePlot(expt.obj, features = c("BBD_Tex"), order = FALSE, pt.size = 0.1) + fix.sc + theme(plot.title = element_blank())
umap_PD1_Tex <- FeaturePlot(expt.obj, features = c("PD1_Tex"), order = FALSE, pt.size = 0.1) + fix.sc + theme(plot.title = element_blank())
umap_TSR <- FeaturePlot(expt.obj, features = c("TSR"), order = FALSE, pt.size = 0.1) + fix.sc + theme(plot.title = element_blank())
umap_Tex_Term <- FeaturePlot(expt.obj, features = c("Tex_Term"), order = FALSE, pt.size = 0.1) + fix.sc + theme(plot.title = element_blank())
umap_Tex_KLR <- FeaturePlot(expt.obj, features = c("Tex_KLR"), order = FALSE, pt.size = 0.1) + fix.sc + theme(plot.title = element_blank())



generate_figs(umap_CARTEx_84, paste('./plots/', experiment, '_cs_prepare_umap_CARTEx_84', sep = ''), c(2.8, 2))
generate_figs(umap_CARTEx_200, paste('./plots/', experiment, '_cs_prepare_umap_CARTEx_200', sep = ''), c(2.8, 2))
generate_figs(umap_CARTEx_630, paste('./plots/', experiment, '_cs_prepare_umap_CARTEx_630', sep = ''), c(2.8, 2))
generate_figs(umap_sig_activation, paste('./plots/', experiment, '_cs_prepare_umap_sig_activation', sep = ''), c(2.8, 2))
generate_figs(umap_sig_anergy, paste('./plots/', experiment, '_cs_prepare_umap_sig_anergy', sep = ''), c(2.8, 2))
generate_figs(umap_sig_stemness, paste('./plots/', experiment, '_cs_prepare_umap_sig_stemness', sep = ''), c(2.8, 2))
generate_figs(umap_sig_senescence, paste('./plots/', experiment, '_cs_prepare_umap_sig_senescence', sep = ''), c(2.8, 2))
generate_figs(umap_NKlike_Tex, paste('./plots/', experiment, '_cs_prepare_umap_NKlike_Tex', sep = ''), c(2.8, 2))
generate_figs(umap_LCMV_Tex, paste('./plots/', experiment, '_cs_prepare_umap_LCMV_Tex', sep = ''), c(2.8, 2))
generate_figs(umap_BBD_Tex, paste('./plots/', experiment, '_cs_prepare_umap_BBD_Tex', sep = ''), c(2.8, 2))
generate_figs(umap_PD1_Tex, paste('./plots/', experiment, '_cs_prepare_umap_PD1_Tex', sep = ''), c(2.8, 2))
generate_figs(umap_TSR, paste('./plots/', experiment, '_cs_prepare_umap_TSR', sep = ''), c(2.8, 2))
generate_figs(umap_Tex_Term, paste('./plots/', experiment, '_cs_prepare_umap_Tex_Term', sep = ''), c(2.8, 2))
generate_figs(umap_Tex_KLR, paste('./plots/', experiment, '_cs_prepare_umap_Tex_KLR', sep = ''), c(2.8, 2))


# FeaturePlot(expt.obj, features = c("Tex_Term", "Tex_KLR"), pt.size = 0.1, blend = TRUE)



# Examine CARTEx scores grouped by age group
vlnplot_CARTEx_630_age_group <- VlnPlot(expt.obj, feature = c("CARTEx_630"), group.by = "AgeGroup2", pt.size = 0) + theme(legend.position = 'none') + ylim(c(-3, 4)) + stat_summary(fun.y = median, geom='point', size = 10, colour = "black", shape = 95)
vlnplot_CARTEx_200_age_group <- VlnPlot(expt.obj, feature = c("CARTEx_200"), group.by = "AgeGroup2", pt.size = 0) + theme(legend.position = 'none') + ylim(c(-3, 4)) + stat_summary(fun.y = median, geom='point', size = 10, colour = "black", shape = 95)
vlnplot_CARTEx_84_age_group <- VlnPlot(expt.obj, feature = c("CARTEx_84"), group.by = "AgeGroup2", pt.size = 0) + theme(legend.position = 'none') + ylim(c(-3, 4)) + stat_summary(fun.y = median, geom='point', size = 10, colour = "black", shape = 95)

generate_figs(vlnplot_CARTEx_630_age_group, paste('./plots/', experiment, '_cs_prepare_vlnplot_CARTEx_630_age_group', sep = ''), c(7,5))
generate_figs(vlnplot_CARTEx_200_age_group, paste('./plots/', experiment, '_cs_prepare_vlnplot_CARTEx_200_age_group', sep = ''), c(7,5))
generate_figs(vlnplot_CARTEx_84_age_group, paste('./plots/', experiment, '_cs_prepare_vlnplot_CARTEx_84_age_group', sep = ''), c(7,5))

vlnplot_activation_age_group <- VlnPlot(expt.obj, feature = c("Activation"), group.by = "AgeGroup2", pt.size = 0) + theme(legend.position = 'none') + ylim(c(-3, 4)) + stat_summary(fun.y = median, geom='point', size = 10, colour = "black", shape = 95)
vlnplot_anergy_age_group <- VlnPlot(expt.obj, feature = c("Anergy"), group.by = "AgeGroup2", pt.size = 0) + theme(legend.position = 'none') + ylim(c(-3, 4)) + stat_summary(fun.y = median, geom='point', size = 10, colour = "black", shape = 95)
vlnplot_senescence_age_group <- VlnPlot(expt.obj, feature = c("Senescence"), group.by = "AgeGroup2", pt.size = 0) + theme(legend.position = 'none') + ylim(c(-3, 4)) + stat_summary(fun.y = median, geom='point', size = 10, colour = "black", shape = 95)
vlnplot_stemness_age_group <- VlnPlot(expt.obj, feature = c("Stemness"), group.by = "AgeGroup2", pt.size = 0) + theme(legend.position = 'none') + ylim(c(-3, 4)) + stat_summary(fun.y = median, geom='point', size = 10, colour = "black", shape = 95)

generate_figs(vlnplot_activation_age_group, paste('./plots/', experiment, '_cs_prepare_vlnplot_activation_age_group', sep = ''), c(7,5))
generate_figs(vlnplot_anergy_age_group, paste('./plots/', experiment, '_cs_prepare_vlnplot_anergy_age_group', sep = ''), c(7,5))
generate_figs(vlnplot_senescence_age_group, paste('./plots/', experiment, '_cs_prepare_vlnplot_senescence_age_group', sep = ''), c(7,5))
generate_figs(vlnplot_stemness_age_group, paste('./plots/', experiment, '_cs_prepare_vlnplot_stemness_age_group', sep = ''), c(7,5))

vlnplot_NKlike_Tex_age_group <- VlnPlot(expt.obj, feature = c("NKlike_Tex"), group.by = "AgeGroup2", pt.size = 0) + theme(legend.position = 'none') + ylim(c(-3, 4)) + stat_summary(fun.y = median, geom='point', size = 10, colour = "black", shape = 95)
vlnplot_LCMV_Tex_age_group <- VlnPlot(expt.obj, feature = c("LCMV_Tex"), group.by = "AgeGroup2", pt.size = 0) + theme(legend.position = 'none') + ylim(c(-3, 4)) + stat_summary(fun.y = median, geom='point', size = 10, colour = "black", shape = 95)
vlnplot_BBD_Tex_age_group <- VlnPlot(expt.obj, feature = c("BBD_Tex"), group.by = "AgeGroup2", pt.size = 0) + theme(legend.position = 'none') + ylim(c(-3, 4)) + stat_summary(fun.y = median, geom='point', size = 10, colour = "black", shape = 95)
vlnplot_PD1_Tex_age_group <- VlnPlot(expt.obj, feature = c("PD1_Tex"), group.by = "AgeGroup2", pt.size = 0) + theme(legend.position = 'none') + ylim(c(-3, 4)) + stat_summary(fun.y = median, geom='point', size = 10, colour = "black", shape = 95)

generate_figs(vlnplot_NKlike_Tex_age_group, paste('./plots/', experiment, '_cs_prepare_vlnplot_NKlike_Tex_age_group', sep = ''), c(7,5))
generate_figs(vlnplot_LCMV_Tex_age_group, paste('./plots/', experiment, '_cs_prepare_vlnplot_LCMV_Tex_age_group', sep = ''), c(7,5))
generate_figs(vlnplot_BBD_Tex_age_group, paste('./plots/', experiment, '_cs_prepare_vlnplot_BBD_Tex_age_group', sep = ''), c(7,5))
generate_figs(vlnplot_PD1_Tex_age_group, paste('./plots/', experiment, '_cs_prepare_vlnplot_PD1_Tex_age_group', sep = ''), c(7,5))


# examine with split by cell type
vlnplot_CARTEx_630_age_group_monaco <- VlnPlot(expt.obj, feature = c("CARTEx_630"), group.by = "AgeGroup2", split.by = "monaco", pt.size = 0, cols = c('deepskyblue','seagreen','darkgoldenrod','plum3')) + ylim(c(-3, 4))
vlnplot_CARTEx_200_age_group_monaco <- VlnPlot(expt.obj, feature = c("CARTEx_200"), group.by = "AgeGroup2", split.by = "monaco", pt.size = 0, cols = c('deepskyblue','seagreen','darkgoldenrod','plum3')) + ylim(c(-3, 4))
vlnplot_CARTEx_84_age_group_monaco <- VlnPlot(expt.obj, feature = c("CARTEx_84"), group.by = "AgeGroup2", split.by = "monaco", pt.size = 0, cols = c('deepskyblue','seagreen','darkgoldenrod','plum3')) + ylim(c(-3, 4))
vlnplot_activation_age_group_monaco <- VlnPlot(expt.obj, feature = c("Activation"), group.by = "AgeGroup2", split.by = "monaco", pt.size = 0, cols = c('deepskyblue','seagreen','darkgoldenrod','plum3')) + ylim(c(-3, 4))
vlnplot_anergy_age_group_monaco <- VlnPlot(expt.obj, feature = c("Anergy"), group.by = "AgeGroup2", split.by = "monaco", pt.size = 0, cols = c('deepskyblue','seagreen','darkgoldenrod','plum3')) + ylim(c(-3, 4))
vlnplot_senescence_age_group_monaco <- VlnPlot(expt.obj, feature = c("Senescence"), group.by = "AgeGroup2", split.by = "monaco", pt.size = 0, cols = c('deepskyblue','seagreen','darkgoldenrod','plum3')) + ylim(c(-3, 4))
vlnplot_stemness_age_group_monaco <- VlnPlot(expt.obj, feature = c("Stemness"), group.by = "AgeGroup2", split.by = "monaco", pt.size = 0, cols = c('deepskyblue','seagreen','darkgoldenrod','plum3')) + ylim(c(-3, 4))
vlnplot_NKlike_Tex_age_group_monaco <- VlnPlot(expt.obj, feature = c("NKlike_Tex"), group.by = "AgeGroup2", split.by = "monaco", pt.size = 0, cols = c('deepskyblue','seagreen','darkgoldenrod','plum3')) + ylim(c(-3, 4))
vlnplot_LCMV_Tex_age_group_monaco <- VlnPlot(expt.obj, feature = c("LCMV_Tex"), group.by = "AgeGroup2", split.by = "monaco", pt.size = 0, cols = c('deepskyblue','seagreen','darkgoldenrod','plum3')) + ylim(c(-3, 4))
vlnplot_BBD_Tex_age_group_monaco <- VlnPlot(expt.obj, feature = c("BBD_Tex"), group.by = "AgeGroup2", split.by = "monaco", pt.size = 0, cols = c('deepskyblue','seagreen','darkgoldenrod','plum3')) + ylim(c(-3, 4))
vlnplot_PD1_Tex_age_group_monaco <- VlnPlot(expt.obj, feature = c("PD1_Tex"), group.by = "AgeGroup2", split.by = "monaco", pt.size = 0, cols = c('deepskyblue','seagreen','darkgoldenrod','plum3')) + ylim(c(-3, 4))

generate_figs(vlnplot_CARTEx_630_age_group_monaco, paste('./plots/', experiment, '_cs_prepare_vlnplot_CARTEx_630_age_group_monaco', sep = ''), c(12,5))
generate_figs(vlnplot_CARTEx_200_age_group_monaco, paste('./plots/', experiment, '_cs_prepare_vlnplot_CARTEx_200_age_group_monaco', sep = ''), c(12,5))
generate_figs(vlnplot_CARTEx_84_age_group_monaco, paste('./plots/', experiment, '_cs_prepare_vlnplot_CARTEx_84_age_group_monaco', sep = ''), c(12,5))
generate_figs(vlnplot_activation_age_group_monaco, paste('./plots/', experiment, '_cs_prepare_vlnplot_activation_age_group_monaco', sep = ''), c(12,5))
generate_figs(vlnplot_anergy_age_group_monaco, paste('./plots/', experiment, '_cs_prepare_vlnplot_anergy_age_group_monaco', sep = ''), c(12,5))
generate_figs(vlnplot_senescence_age_group_monaco, paste('./plots/', experiment, '_cs_prepare_vlnplot_senescence_age_group_monaco', sep = ''), c(12,5))
generate_figs(vlnplot_stemness_age_group_monaco, paste('./plots/', experiment, '_cs_prepare_vlnplot_stemness_age_group_monaco', sep = ''), c(12,5))
generate_figs(vlnplot_NKlike_Tex_age_group_monaco, paste('./plots/', experiment, '_cs_prepare_vlnplot_NKlike_Tex_age_group_monaco', sep = ''), c(12,5))
generate_figs(vlnplot_LCMV_Tex_age_group_monaco, paste('./plots/', experiment, '_cs_prepare_vlnplot_LCMV_Tex_age_group_monaco', sep = ''), c(12,5))
generate_figs(vlnplot_BBD_Tex_age_group_monaco, paste('./plots/', experiment, '_cs_prepare_vlnplot_BBD_Tex_age_group_monaco', sep = ''), c(12,5))
generate_figs(vlnplot_PD1_Tex_age_group_monaco, paste('./plots/', experiment, '_cs_prepare_vlnplot_PD1_Tex_age_group_monaco', sep = ''), c(12,5))


###

saveRDS(expt.obj, file = paste('./data/', experiment, '_cs_scored.rds', sep = ''))

# expt.obj <- readRDS(paste('./data/', experiment, '_cs_scored.rds', sep = ''))

head(expt.obj)



# report time
print("The script has completed...")
proc.time() - ptm

sessionInfo()


# expt.obj <- SetIdent(expt.obj, value = 'Cohort')
# expt.list <- SplitObject(expt.obj, split.by = "Cohort")

# saveRDS(expt.list$`Cross-sectional`, file = paste('./data/', experiment, '_annotated_cross.rds', sep = ''))
# saveRDS(expt.list$`Longitudinal`, file = paste('./data/', experiment, '_annotated_long.rds', sep = ''))


# expt.obj <- SetIdent(expt.obj, value = "monaco")
# levels(expt.obj) <- c('Naive CD8 T cells', 'Effector memory CD8 T cells', 'Central memory CD8 T cells', 'Terminal effector CD8 T cells')

# vlnplot_CARTEx_84_monaco <- VlnPlot(expt.obj, features = c("CARTEx_84"), group.by = 'monaco', pt.size = 0) + 
#   theme(legend.position = 'none') + geom_boxplot(width=0.2, color="black", alpha=0)
# generate_figs(vlnplot_CARTEx_84_monaco, paste('./plots/', experiment, '_vlnplot_CARTEx_84_monaco', sep = ''))




